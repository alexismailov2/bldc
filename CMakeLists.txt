cmake_minimum_required(VERSION 3.19)

project(ChibiOS_CMake)

set(CMAKE_VERBOSE_MAKEFILE ON)

# Should be generated by cmake
include_directories(
        #common/CMSIS/pac55xx
        configs)

find_package(ChibiOS REQUIRED)

# Creating binary with linking scmRTOS libs
add_executable(${PROJECT_NAME}.elf
        ${ALLCSRC}
        ${ALLCPPSRC}
        ${ALLASMSRC}
        ${ALLXASMSRC}
        main.c)

target_include_directories(${PROJECT_NAME}.elf
        PUBLIC
        ${CONFDIR}
        ${ALLINC})

# Converting elf to bin and hex
set(HEX_FILE ${PROJECT_BINARY_DIR}/${PROJECT_NAME}.hex)
set(BIN_FILE ${PROJECT_BINARY_DIR}/${PROJECT_NAME}.bin)

add_custom_command(TARGET ${PROJECT_NAME}.elf POST_BUILD
        COMMAND ${CMAKE_OBJCOPY} -Oihex $<TARGET_FILE:${PROJECT_NAME}.elf> ${HEX_FILE}
        COMMAND ${CMAKE_OBJCOPY} -Obinary $<TARGET_FILE:${PROJECT_NAME}.elf> ${BIN_FILE}
        COMMENT "Building ${HEX_FILE}
Building ${BIN_FILE}")

#target_link_libraries(${PROJECT_NAME}.elf
#        -Wl,--whole-archive
#        ${ChibiOS_LIBS}
#        -Wl,--no-whole-archive)